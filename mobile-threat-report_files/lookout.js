/*
 * LOOKOUT CONTROLLER - Javascript controller for the Lookout site.
 */
Lookout.Controller = (function() {
  /* Private members */
  var _carouselPos = 0, //change this to 0 when re-enabling the video
      _newsPos = 0,
      _videoIFrame,
      _videoIFrameWrap,
      _videoSrc = "http://vimeo.com/moogaloop.swf?clip_id=17372077&amp;title=0&amp;byline=0&amp;portrait=0&amp;color=669900&amp;autoplay=1";

  /* Private methods */
  function _setupCarousel() {
    $(".carousel-container .arrow").click(function(e) {            
      // Prevent the default behaviour of the <a> tag
      e.preventDefault();
      
      // Incrememt or decrement the position
      if($(this).hasClass("next")) {
        _carouselPos = (_carouselPos >= Lookout.carousel.length - 1) ? 0 : _carouselPos + 1;
      } else {
        _carouselPos = (_carouselPos <= 0) ? Lookout.carousel.length - 1 : _carouselPos - 1;
      }
      
      // Swap the image and text
      $(".carousel-caption").fadeOut("normal");
      $(".carousel-img").fadeOut("normal", function() {
        var img = $(".carousel-img");
        
        // Show the video play button
// Uncomment to re-enable the video
        if(_carouselPos == 0) {
          _videoButton.show();
		  $(".carousel-caption").hide();
        }
//               
        img.attr("src", Lookout.carousel[_carouselPos]['img'])
               .bind("load", function() { 
                  img.fadeIn();
                 if(_carouselPos != 0) {
				 	$(".carousel-caption").html(Lookout.carousel[_carouselPos]['caption']).show();
				 } 
                });
      });
// Uncomment to re-enable the video
      if(_carouselPos > 0 ) {
        _videoButton.hide()
        _videoIFrameWrap.hide();
        _videoIFrame.attr("src", "");
      }
//      
    });
    
    // Video button
    $("#lookout-video-button a").live("click", function(e) {
      e.preventDefault();
      _videoButton.hide();
      _videoIFrame.attr("src", _videoSrc);
      _videoIFrameWrap.show();
    });
    
    // Close button
    $("#lookout-video-close").click(function(e) {
      e.preventDefault();
      
      _videoIFrameWrap.hide();
      _videoIFrame.attr("src", "");
      _videoButton.show();
    });
    
  }
  
  function _setupNewsItems() {
    $(".news .arrow").click(function(e) {            
      // Prevent the default behaviour of the <a> tag
      e.preventDefault();
      
      // Incrememt or decrement the position
      if($(this).hasClass("next")) {
        _newsPos = (_newsPos >= Lookout.news.length - 1) ? 0 : _newsPos + 1;
      } else {
        _newsPos = (_newsPos <= 0) ? Lookout.news.length - 1 : _newsPos - 1;
      }
      
      // Swap the link and text
      _swapNewsItem();
	  clearInterval( newsSwap );
	  _timedNewsItemSwap();
    });
  }

  //swpa link and text for news items
  function _swapNewsItem() {
	$(".news-headline").attr({"href": Lookout.news[_newsPos]['link'],"onClick":  Lookout.news[_newsPos]['onclick']})
                         .fadeOut("fast", function() {
                           $(this).html(Lookout.news[_newsPos]['title'] + " &#187;")
                                  .show();
                         });
  }

  //change news stories every 5 seconds
  function _timedNewsItemSwap() {
	newsSwap = setInterval(function() {
		_newsPos = (_newsPos >= Lookout.news.length - 1) ? 0 : _newsPos + 1;
		_swapNewsItem(); 
	}, 5000);
  }
  
  // Stories widget slideshow
  function _storiesWidgetSlideshow() {
      if( $("#stories-widget").length > 0 && storiesWidget && storiesWidget.length > 0 ) {      
          // Remove the first story
          var index = 0,
              firstStory = storiesWidget.shift();
              
          // Randomly sort the arrat
          storiesWidget.sort(function() {return 0.5 - Math.random()})
          // Put the first story at the end
          storiesWidget.push(firstStory);
                    
          setInterval(function() {
              var nextStory = storiesWidget[index],
				  fullName = nextStory.lookout_story_first_name[0];
                  //fullName = nextStory.lookout_story_first_name[0] + " " + nextStory.lookout_story_last_name[0];
                 
              $("#stories-widget").height( $("#stories-widget").height() )
                                  .find("#stories-widget-content").fadeOut(function() {
                                        $("#stories-widget-img").attr("src", nextStory.lookout_story_thumbnail[0]);
                                        $("#stories-widget-permalink").attr("href", nextStory.permalink);
                                        $("#stories-widget-quote").text(nextStory.lookout_story_quote[0]);
                                        $("#stories-widget-firstname").text(nextStory.lookout_story_first_name[0]);
                                        $("#stories-widget-fullname").text(fullName);
                                        index = (storiesWidget.length - 1 == index) ? 0 : index + 1;
                                        
                                        $(this).fadeIn(function() {
                                            $("#stories-widget").css("height", "auto");
                                        });
                                  });
          }, 12000);
          
          // Preload images
          $(storiesWidget).each(function(){
              $('<img/>')[0].src = this.lookout_story_thumbnail[0];
          });
      }
  }
  
  // Heros slideshow
  function _herosSlideshow() {
      if( $("#hero").length > 0 && heros && heros.length > 0 ) {
          // Remove the first story
          var index = 0,
              firstHero = heros.shift();

          // Randomly sort the array
          heros.sort(function() {return 0.5 - Math.random()})
          // Put the first story at the end
          heros.push(firstHero);

          setInterval(function() {
              var nextHero = heros[index];

              $("#hero-subheading").fadeOut();
              $("#hero-tagline").fadeOut(function() {
                        $("#hero-tagline").text(nextHero.lookout_hero_tagline[0]);
                        $("#hero-subheading").text(nextHero.lookout_hero_subheading[0]);
                        $("#home").css("background-image", "url(" + nextHero.lookout_hero_background[0] + ")")
                        $("#home #pre-wrapper").css("background-image", "url(" + nextHero.lookout_hero_image[0] + ")")
                        index = (heros.length - 1 == index) ? 0 : index + 1;
                        
                        // Tag the hero with iPhone or Android class
                        $("#hero").removeClass("android iphone").addClass(nextHero.lookout_hero_os[0]);

                        $(this).fadeIn();
                        $("#hero-subheading").fadeIn();
                  });
          }, 12000);
          
          // Preload images
          $(heros).each(function(){
              $('<img/>')[0].src = this.lookout_hero_background[0];
              $('<img/>')[0].src = this.lookout_hero_image[0];
          });
      }
  }
  
  // What runs on document.ready
  function _init() {
    
    // Carousel
    if(Lookout.carousel) _setupCarousel();
    
    // News Items
    if (Lookout.news) {
		//make the news items
		_setupNewsItems();
		_timedNewsItemSwap();
	};

	

    // Replace all of the mailto hrefs (avoid spam)
    var at = / at /;
    var dot = / dot /g;
    $('span.mailme').each(function() {
      var addr = $(this).text().replace(at,"@").replace(dot,".");
      $(this).after('<a href="mailto:'+addr+'" title="Send an email">'+ addr +'</a>')
            .hover(function(){window.status="Send a letter!";}, function(){window.status="";})
            .remove();
    });
    
    // Search Form
    if ($('.de #search-form').length > 0) {
      $('#search-form #search').example("Suchen Sie in unsere Support-Seite");
    } else if ($(".ja #search-form").length > 0) {
      $('#search-form #search').example("Lookoutのヘルプセンターを検索 (英語のみ)");
    } else if ($(".fr #search-form").length > 0) {
      $('#search-form #search').example("Rechercher sur notre forum d'assistance (en anglais)");
    } else if ($('.br #search-form').length > 0) {
      $('#search-form #search').example('Pesquise em nosso centro de suporte em Inglês');
    } else if ($('.es #search-form').length > 0) {
      $('#search-form #search').example('Busca en nuestro centro de soporte en inglés');
    } else if ($("#search-form").length > 0) {
      $('#search-form #search').example("Search our help center");
    }
    
    questions = $(".question");
    if(questions.length > 0) {
      questions.click(function(e) {
        e.preventDefault();
        $(this).next(".answer").toggle();
      });
    }
// Uncomment to re-enable the video
    // Setup the video iframe
    _videoIFrame = $("#lookout-video");
    _videoIFrameWrap = $("#lookout-video-wrap");
    _videoButton = $("#lookout-video-button");
  

    // QR Code Zoom
	$('a.zoom').fancyZoom({directory: "/_gfx/fancyzoom"});
    
    // Download drawers
    if($("#download .android").length > 0) {
      
      $("#download .android").click(function(e) {
        e.preventDefault();
        $("#download .drawer-android").slideToggle("fast");
        $(this).parent("li").toggleClass("active");
      });
      
      // $("#download .drawer-button").click(function(e) {
      //           e.preventDefault();
      //           var from,
      //               classes = ['android', 'windows', 'other'],
      //               self = this;
      //           
      //           $.each(classes, function(index, value) {
      //             if($(self).hasClass(value)) {
      //               from = value;
      //               return false;
      //             }
      //           });
      //           
      //           // Close others that are open
      //           if($("#download .drawer:visible").length > 0) {
      //             $("#download .active").removeClass("active");
      //             $("#download .drawer:visible").hide();
      //             $("#download .drawer-" + from).show();
      //           } else {
      //             $("#download .drawer-" + from).slideDown("fast");
      //           }
      //           
      //           $(this).parent("li").addClass("active");
      //           
      //       });
    }
    
    // Careers page
    if( $('body#careers').length > 0 ) {
		// fade in and out the quotes if there's more than 1 quote
		if ($('div.quote').size() > 1) {
			setInterval(function(){
				$('.careers-quote .quote').filter(':visible').fadeOut('slow',function(){
					if($(this).next('div.quote').size()){
						$(this).next().delay(300).fadeIn('slow');
					}
					else{
						$('.careers-quote .quote').eq(0).delay(300).fadeIn('slow');
					}
				});
			},8000);
		}
        // Slideshow and carousel
        slideshow = $("#careers .slideshow").jcarousel({
                            wrap: 'both'
                        })
                       .find('a').click(function(e) {
                           var src = $(this).attr("href");
                           
                           e.preventDefault();
                           
                           $("#careers .slideshow a.selected").removeClass("selected");
                           $(this).addClass("selected");
                           
                           $(".main-image").attr("src", src);
                        }).end();
        
        // If the user clicks on the main image, advance the slideshow by one           
        $(".main-image-link").click(function(e) {
            e.preventDefault();
            
            var thumbs = $(".slideshow a"),
                currentIndex = thumbs.index($(".slideshow a.selected")),
                nextIndex = (currentIndex + 1 >= thumbs.length) ? 0 : currentIndex + 1;
                next = thumbs.eq(nextIndex);                
                
            $(".main-image").attr("src", next.attr("href"));
            $("#careers .slideshow a.selected").removeClass("selected");
            next.addClass("selected");
            slideshow.data('jcarousel').scroll(nextIndex + 1);
        });
    }
    
    // Stories page
    // For some reason, IE 7 isn't redirecting after this click
    // So, this is a little helper function
    $("#stories .jcarousel-item a").click(function(){
       window.location.href = $(this).attr("href");
    });
    
	//Resources Overview page
    if( $('body.mobile-lost-and-found').length > 0 ) {
		// fade in and out the quotes if there's more than 1 quote
		setInterval(function(){
			$('#quote-carousel .carousel-item').filter(':visible').fadeOut('slow',function(){
				if($(this).next('div.carousel-item').size()){
					$(this).next().delay(300).fadeIn('slow');
				}
				else{
					$('#quote-carousel .carousel-item').eq(0).delay(300).fadeIn('slow');
				}
			});
		},8000);
	}
	
	if($('body#resources #overlay').length > 0) {
		$('#overlay').height($('.dataviz').height());
	}
	
    // Stories Widget Slideshow
    _storiesWidgetSlideshow();
    
    // Heros Slideshow
    //_herosSlideshow();

  };
  $(document).ready(_init);
  
  /* Public methods */
  return {}
  
})();

/* Run these immediately. No need to wait for document.ready */
if(BrowserDetect.OS == "Windows" && BrowserDetect.browser == "Chrome") {
	$("body").addClass("no-typekit");
}